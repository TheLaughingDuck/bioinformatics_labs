---
title: "Lab 5"
author: "Max Bj√∂rklund & Simon Jorstedt"
date: "`r Sys.Date()`"
output: html_document
---

```{r,message=FALSE, warning=FALSE}
# Dependencies
library(magrittr)
library(igraph)
```

# Question 1
*Go to the webpage http://snap.stanford.edu/biodata/ and choose one of the provided datasets. Download it and reproduce the statistics concerning the graph. If you obtain different values, then discuss this in your report. Visualize the graph. The next step is to try to identify some clusters (communities in the graph). You can follow the tutorial at https://psych-networks.com/r-tutorial-identify-communities-items-networks/ to achieve this. Once you have found some clusters, identify the elements in it and try to find information on this cluster. Is it related to some known biological phenomena? If you do not find anything, then document your search attempts. If it will not be possible to do this question on the whole downloaded graph, then you may take some sub-graph of it.*

From the provided website we obtain the "SS-Butterfly_weights.tsv.gz" dataset. In the chunk below, we obtain some properties/statistics of the dataset. We find that the graph as provided is fully connected, directed, and non-cyclic. However, it is implied that the direction describes the nature of the similarity (captured by edge weight). Therefore we will treat all edges as bidirectional. Similarly to the website, we find in the chunk below that the number of nodes and edges are 832 and 86528. There is one strongly connected component, containing all nodes. Below in Figure 1 are the properties according to the website.

![Fig. 1: Apparently true properties](butterfly_statistics.png)

```{r}
# Load data
butterfly_weights <- read.table(gzfile("SS-Butterfly_weights.tsv.gz"))
butterfly_names <- read.table(gzfile("SS-Butterfly_labels.tsv.gz"))

# Number of nodes
c(butterfly_weights$V1, butterfly_weights$V2) %>% unique() %>% length()

# Number of edges
nrow(butterfly_weights)

# Finding the number of strongly connected components
graph_1 <- igraph::graph_from_data_frame(butterfly_weights[,c(1,2)], directed = FALSE)
igraph::components(graph_1, mode="strong")$membership %>% unique() %>% length()
```

Now we obtain the average clustering coefficient (which matches with the website), and the number of triangles, which does not match. The website suggests that there are over 14 million triangles, but even if we count all the triangles for every node and sum them up (triple-counting all triangles), we only achieve about 13 million triangles/triples. In turn, we achieve a different fraction of closed triangles. Also the diameter is different. We also find that all nodes are connected by a path with a most 4 nodes, and so it makes sense that the 90-percentile effective diameter is very low, although the corresponding value on the website is slightly lower (1.918374). Regarding the "number of triangles", we will conclude that the website is too unspecific to warrant further investigation.

```{r}
# Average clustering coefficient
igraph::transitivity(graph_1, type="average")

# Number of triangles
igraph::count_triangles(graph_1) %>% sum()

# Fraction of closed triangles
igraph::transitivity(graph_1, type="global")

# Diameter
igraph::diameter(graph_1)

# 90 percentile effective diameter
sp_lengths <- igraph::distances(graph_1)
quantile(sp_lengths, 0.9)
```

Now we perform Louvain clustering, and plot the result in Figure 2. This not very informative, since there are many nodes that are all quite tightly connected. In Figure 3 below we see the separation of butterflies into the four clusters generated by the louvain clustering. We tried multiple values for the resolutions parameter and found that a value of 1 or 1.1 achieved best clustering. The data only contains integer representation of the species, which we must assume is to properly anonymize the butterflies identities. In Figure 3, we see clearly that some species were easier to differentiate than others, but no one species is completely separated from the others. For example, species 6 and 9 are both clustered together with few butterflies from the other species, while species 3, 7 are clustered together, along with a not insignificant amount of butterflies from species 2, 9 and 10. Note that some jitter has been added to differentiate overlapping points.

```{r}
# Perform louvain clustering and then plot the graph
louvain <- igraph::cluster_louvain(graph_1, resolution = 1.1)
plot(louvain, graph_1, vertex.size = 1, vertex.label = NA,
     layout = layout_with_fr(graph_1),
     main="Fig. 2: Clustered graph")
```


```{r}
plot(y = jitter(louvain$membership), x=jitter(butterfly_names$V2),
     main="Fig. 3: Inferred vs true species.",
     xlab="True species",
     ylab="Inferred species")
```


# Question 2

Recreate one of the three analyses that can be found on <https://strimmerlab.github.io/> software/genenet/index.html. Document and discuss all your steps. In the analyses there is the step where you select the edges to keep. There a particular criterion is chosen for edge inclusion. Vary this criterion and explore how the resulting clusters will differ with the changes. Take one found cluster, identify the elements in it and try to find information on this cluster. Is it related to some known biological phenomena? If you do not find anything, then document your search attempts.

## Analysis chosen: E.coli

```{r}
#Loading the package
library("GeneNet")
library("Rgraphviz")
#BiocManager::install("org.EcK12.eg.db")
library(org.EcK12.eg.db)

#Loading the ecoli-data
data(ecoli)
#Displaying 9 observations as time points with 102 genes. 
dim(ecoli)

#Using shrinkage estimator to produce a matrix of partial correlation between genes
pc = ggm.estimate.pcor(ecoli)
#The covariance matrix of 102 genes
dim(pc)

#Estimating q-values (fdr = TRUE) and additional statistics (direct = TRUE)
ecoli.edges = network.test.edges(pc, direct=TRUE, fdr=TRUE)
#With 102 genes, we have 5151 potenial pairings of genes, meaning 5151 edges in the network 
dim(ecoli.edges)




```

### FDR cutoff 0.2

```{r}
ecoli.net = extract.network(ecoli.edges)

node.labels = colnames(ecoli)
gr = network.make.graph(ecoli.net, node.labels, drop.singles=TRUE)
table(  edge.info(gr)$dir )
sort( node.degree(gr), decreasing=TRUE)


#' Set node and edge attributes for more beautiful graph plotting:
globalAttrs = list()
globalAttrs$edge = list(color = "black", lty = "solid", lwd = 1, arrowsize=1)
globalAttrs$node = list(fillcolor = "lightblue", shape = "ellipse", fixedsize = FALSE)
 
nodeAttrs = list()
nodeAttrs$fillcolor = c('sucA' = "yellow")

edi = edge.info(gr)
edgeAttrs = list()
edgeAttrs$dir = edi$dir # set edge directions 
edgeAttrs$lty = ifelse(edi$weight < 0, "dotted", "solid") # negative correlation -> dotted
edgeAttrs$color = ifelse(edi$dir == "none", "black", "red")
edgeAttrs$label = round(edi$weight, 2) # use partial correlation as edge labels

#+ fig.width=8, fig.height=7
plot(gr, attrs = globalAttrs, nodeAttrs = nodeAttrs, edgeAttrs = edgeAttrs, "fdp")
```

```{r}
cluster_desc <- select(org.EcK12.eg.db, keys = c("sucA", "atpC", "sodA", "gltA", "dnaJ", "gatD", "atpH", "sucD", "flgD", "manX"), columns = "GENENAME", keytype = "ALIAS")
```

The cluster has multiple genes which plays a part in ATP synthesis and citric acid cycle.

### FDR cutoff 0.1

```{r}
ecoli.net = extract.network(ecoli.edges, cutoff.ggm=0.9, cutoff.dir=0.9)

node.labels = colnames(ecoli)
gr = network.make.graph(ecoli.net, node.labels, drop.singles=TRUE)
table(  edge.info(gr)$dir )
sort( node.degree(gr), decreasing=TRUE)


#' Set node and edge attributes for more beautiful graph plotting:
globalAttrs = list()
globalAttrs$edge = list(color = "black", lty = "solid", lwd = 1, arrowsize=1)
globalAttrs$node = list(fillcolor = "lightblue", shape = "ellipse", fixedsize = FALSE)
 
nodeAttrs = list()
nodeAttrs$fillcolor = c('sucA' = "yellow")

edi = edge.info(gr)
edgeAttrs = list()
edgeAttrs$dir = edi$dir # set edge directions 
edgeAttrs$lty = ifelse(edi$weight < 0, "dotted", "solid") # negative correlation -> dotted
edgeAttrs$color = ifelse(edi$dir == "none", "black", "red")
edgeAttrs$label = round(edi$weight, 2) # use partial correlation as edge labels

#+ fig.width=8, fig.height=7
plot(gr, attrs = globalAttrs, nodeAttrs = nodeAttrs, edgeAttrs = edgeAttrs, "fdp")
```

```{r}
select(org.EcK12.eg.db, keys = c("sucA", "tnaA", "flgD", "sucD", "gltA", "atpG", "yhdM", "dnaJ", "yfaD"), columns = "GENENAME", keytype = "ALIAS")

select(org.EcK12.eg.db, keys = c("yheI", "ycgX","dnaG","folK","dnaK","b1963","yedE","atpD"), columns = "GENENAME", keytype = "ALIAS")
```

The first cluster is similar to the 0.2-cutoff and has multiple genes which plays a part in APT synthesis and citric acid cycle.

The second cluster does not seem to be related to any obvious common biological phenomenon.

### 70 stronges edges 

```{r}
ecoli.net = extract.network(ecoli.edges, method.ggm="number", cutoff.ggm=70)

node.labels = colnames(ecoli)
gr = network.make.graph(ecoli.net, node.labels, drop.singles=TRUE)
table(  edge.info(gr)$dir )
sort( node.degree(gr), decreasing=TRUE)


#' Set node and edge attributes for more beautiful graph plotting:
globalAttrs = list()
globalAttrs$edge = list(color = "black", lty = "solid", lwd = 1, arrowsize=1)
globalAttrs$node = list(fillcolor = "lightblue", shape = "ellipse", fixedsize = FALSE)
 
nodeAttrs = list()
nodeAttrs$fillcolor = c('sucA' = "yellow")

edi = edge.info(gr)
edgeAttrs = list()
edgeAttrs$dir = edi$dir # set edge directions 
edgeAttrs$lty = ifelse(edi$weight < 0, "dotted", "solid") # negative correlation -> dotted
edgeAttrs$color = ifelse(edi$dir == "none", "black", "red")
edgeAttrs$label = round(edi$weight, 2) # use partial correlation as edge labels

#+ fig.width=8, fig.height=7
plot(gr, attrs = globalAttrs, nodeAttrs = nodeAttrs, edgeAttrs = edgeAttrs, "fdp")
```

```{r}
select(org.EcK12.eg.db, keys = c("sucA", "ygcE","sucD","atpG","dnaJ","gltA","flgD","yhdM","yfaD","fnaA"), columns = "GENENAME", keytype = "ALIAS")

```

The cluster is similar to the 0.2-cutoff and 0.1-cutoff and has multiple genes which plays a part in APT synthesis and citric acid cycle.